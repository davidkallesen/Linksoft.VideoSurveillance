@page "/settings"
@using Linksoft.VideoSurveillance.BlazorApp.Pages.SettingsTabs
@inject GatewayService Gateway
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">Settings</MudText>

@if (isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudPaper Class="pa-4" MaxWidth="800px">
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <MudTabPanel Text="General">
                <GeneralTab State="state" />
            </MudTabPanel>
            <MudTabPanel Text="Camera Display">
                <CameraDisplayTab State="state" />
            </MudTabPanel>
            <MudTabPanel Text="Connection">
                <ConnectionTab State="state" />
            </MudTabPanel>
            <MudTabPanel Text="Performance">
                <PerformanceTab State="state" />
            </MudTabPanel>
            <MudTabPanel Text="Motion Detection">
                <MotionDetectionTab State="state" />
            </MudTabPanel>
            <MudTabPanel Text="Recording">
                <RecordingTab State="state" />
            </MudTabPanel>
            <MudTabPanel Text="Advanced">
                <AdvancedTab State="state" />
            </MudTabPanel>
        </MudTabs>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Class="mt-4"
                   OnClick="SaveSettingsAsync"
                   Disabled="isSaving">
            @(isSaving ? "Saving..." : "Save Settings")
        </MudButton>
    </MudPaper>
}

@code {
    private readonly SettingsState state = new();
    private bool isLoading = true;
    private bool isSaving;

    protected override async Task OnInitializedAsync()
    {
        var settings = await Gateway.GetSettingsAsync();
        if (settings is not null)
        {
            state.LoadFrom(settings);
        }

        isLoading = false;
    }

    private async Task SaveSettingsAsync()
    {
        isSaving = true;

        var result = await Gateway.UpdateSettingsAsync(state.ToApiModel());
        if (result is not null)
        {
            Snackbar.Add("Settings saved.", Severity.Success);
        }
        else
        {
            Snackbar.Add("Failed to save settings.", Severity.Error);
        }

        isSaving = false;
    }
}