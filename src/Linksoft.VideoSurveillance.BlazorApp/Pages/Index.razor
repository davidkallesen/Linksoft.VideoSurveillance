@page "/"
@inject GatewayService Gateway
@inject SurveillanceHubService Hub
@implements IDisposable

<MudText Typo="Typo.h4" Class="mb-4">Dashboard</MudText>

<MudGrid>
    <MudItem xs="12" sm="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.Videocam" Size="Size.Large" Color="Color.Primary" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5">@cameraCount</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Cameras</MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.Wifi" Size="Size.Large" Color="Color.Success" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5">@connectedCount</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Connected</MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.GridView" Size="Size.Large" Color="Color.Info" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5">@layoutCount</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Layouts</MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.FiberManualRecord" Size="Size.Large" Color="Color.Error" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5">@recordingCount</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Active Recordings</MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-4">
    <MudItem xs="12" sm="6">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/cameras" StartIcon="@Icons.Material.Filled.Videocam" FullWidth="true">
            Manage Cameras
        </MudButton>
    </MudItem>
    <MudItem xs="12" sm="6">
        <MudButton Variant="Variant.Filled" Color="Color.Secondary" Href="/live" StartIcon="@Icons.Material.Filled.LiveTv" FullWidth="true">
            Live View
        </MudButton>
    </MudItem>
</MudGrid>

<MudText Typo="Typo.caption" Class="mt-4" Color="Color.Secondary">
    Hub: @Hub.ConnectionState
</MudText>

@code {
    private int cameraCount;
    private int connectedCount;
    private int layoutCount;
    private int recordingCount;

    protected override async Task OnInitializedAsync()
    {
        Hub.OnConnectionStateChanged += OnConnectionStateChanged;
        Hub.OnRecordingStateChanged += OnRecordingStateChanged;

        await Hub.ConnectAsync();

        var cameras = await Gateway.GetCamerasAsync();
        cameraCount = cameras?.Length ?? 0;

        var layouts = await Gateway.GetLayoutsAsync();
        layoutCount = layouts?.Length ?? 0;

        var recordings = await Gateway.GetRecordingsAsync();
        recordingCount = recordings?.Length ?? 0;
    }

    private void OnConnectionStateChanged(SurveillanceHubService.ConnectionStateEvent e)
    {
        InvokeAsync(() =>
        {
            if (string.Equals(e.NewState, "Connected", StringComparison.OrdinalIgnoreCase))
            {
                connectedCount++;
            }
            else if (string.Equals(e.NewState, "Disconnected", StringComparison.OrdinalIgnoreCase)
                     || string.Equals(e.NewState, "Error", StringComparison.OrdinalIgnoreCase))
            {
                connectedCount = Math.Max(0, connectedCount - 1);
            }

            StateHasChanged();
        });
    }

    private void OnRecordingStateChanged(SurveillanceHubService.RecordingStateEvent e)
    {
        InvokeAsync(() =>
        {
            if (string.Equals(e.NewState, "Recording", StringComparison.OrdinalIgnoreCase))
            {
                recordingCount++;
            }
            else if (string.Equals(e.OldState, "Recording", StringComparison.OrdinalIgnoreCase))
            {
                recordingCount = Math.Max(0, recordingCount - 1);
            }

            StateHasChanged();
        });
    }

    public void Dispose()
    {
        Hub.OnConnectionStateChanged -= OnConnectionStateChanged;
        Hub.OnRecordingStateChanged -= OnRecordingStateChanged;
    }
}