@page "/cameras"
@inject GatewayService Gateway
@inject SurveillanceHubService Hub
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<MudText Typo="Typo.h4" Class="mb-4">Cameras</MudText>

<MudButton Variant="Variant.Filled"
           Color="Color.Primary"
           StartIcon="@Icons.Material.Filled.Add"
           Class="mb-4"
           Href="/cameras/create">
    Add Camera
</MudButton>

@if (isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudTable Items="@cameras" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>IP Address</MudTh>
            <MudTh>Port</MudTh>
            <MudTh>Protocol</MudTh>
            <MudTh>State</MudTh>
            <MudTh>Recording</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.DisplayName</MudTd>
            <MudTd DataLabel="IP Address">@context.IpAddress</MudTd>
            <MudTd DataLabel="Port">@context.Port</MudTd>
            <MudTd DataLabel="Protocol">@context.Protocol</MudTd>
            <MudTd DataLabel="State">
                <MudChip T="string"
                         Size="Size.Small"
                         Color="@GetConnectionColor(context.ConnectionState)">
                    @(context.ConnectionState?.ToString() ?? "Unknown")
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Recording">
                @if (context.IsRecording)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Error">Recording</MudChip>
                }
            </MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Size="Size.Small"
                               OnClick="@(() => Navigation.NavigateTo($"/cameras/{context.Id}/edit"))" />
                <MudIconButton Icon="@Icons.Material.Filled.CameraAlt"
                               Size="Size.Small"
                               OnClick="@(() => CaptureSnapshotAsync(context))" />
                @if (context.IsRecording)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Stop"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   OnClick="@(() => StopRecordingAsync(context.Id))" />
                }
                else
                {
                    <MudIconButton Icon="@Icons.Material.Filled.FiberManualRecord"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   OnClick="@(() => StartRecordingAsync(context.Id))" />
                }
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Size="Size.Small"
                               Color="Color.Error"
                               OnClick="@(() => DeleteCameraAsync(context))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No cameras configured. Click "Add Camera" to get started.</MudText>
        </NoRecordsContent>
    </MudTable>
}

@code {
    private Camera[]? cameras;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        Hub.OnConnectionStateChanged += OnConnectionStateChanged;
        Hub.OnRecordingStateChanged += OnRecordingStateChanged;

        await Hub.ConnectAsync();
        await LoadCamerasAsync();
    }

    private async Task LoadCamerasAsync()
    {
        isLoading = true;
        cameras = await Gateway.GetCamerasAsync();
        isLoading = false;
    }

    private void OnConnectionStateChanged(SurveillanceHubService.ConnectionStateEvent e)
    {
        InvokeAsync(() =>
        {
            if (cameras is null)
            {
                return;
            }

            for (var i = 0; i < cameras.Length; i++)
            {
                if (cameras[i].Id == e.CameraId)
                {
                    cameras[i] = cameras[i] with
                    {
                        ConnectionState = Enum.TryParse<CameraConnectionState>(e.NewState, ignoreCase: true, out var state)
                            ? state
                            : cameras[i].ConnectionState,
                    };
                    break;
                }
            }

            StateHasChanged();
        });
    }

    private void OnRecordingStateChanged(SurveillanceHubService.RecordingStateEvent e)
    {
        InvokeAsync(() =>
        {
            if (cameras is null)
            {
                return;
            }

            for (var i = 0; i < cameras.Length; i++)
            {
                if (cameras[i].Id == e.CameraId)
                {
                    var isRecording = string.Equals(e.NewState, "Recording", StringComparison.OrdinalIgnoreCase);
                    cameras[i] = cameras[i] with { IsRecording = isRecording };
                    break;
                }
            }

            StateHasChanged();
        });
    }

    private async Task DeleteCameraAsync(Camera camera)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"Delete camera '{camera.DisplayName}'? This cannot be undone." },
            { x => x.ButtonText, "Delete" },
            { x => x.Color, Color.Error },
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Camera", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await Gateway.DeleteCameraAsync(camera.Id);
            Snackbar.Add($"Camera '{camera.DisplayName}' deleted.", Severity.Success);
            await LoadCamerasAsync();
        }
    }

    private async Task StartRecordingAsync(Guid cameraId)
    {
        var status = await Gateway.StartRecordingAsync(cameraId);
        if (status is not null)
        {
            Snackbar.Add("Recording started.", Severity.Success);
            await LoadCamerasAsync();
        }
        else
        {
            Snackbar.Add("Failed to start recording.", Severity.Error);
        }
    }

    private async Task StopRecordingAsync(Guid cameraId)
    {
        var status = await Gateway.StopRecordingAsync(cameraId);
        if (status is not null)
        {
            Snackbar.Add("Recording stopped.", Severity.Success);
            await LoadCamerasAsync();
        }
        else
        {
            Snackbar.Add("Failed to stop recording.", Severity.Error);
        }
    }

    private async Task CaptureSnapshotAsync(Camera camera)
    {
        Snackbar.Add($"Capturing snapshot from '{camera.DisplayName}'...", Severity.Info);
        var base64 = await Gateway.CaptureSnapshotAsync(camera.Id);
        if (base64 is not null)
        {
            var fileName = $"{camera.DisplayName}_{DateTime.Now:yyyyMMdd_HHmmss}.png";
            await JS.InvokeVoidAsync("fileInterop.downloadBlob", base64, fileName, "image/png");
            Snackbar.Add("Snapshot downloaded.", Severity.Success);
        }
        else
        {
            Snackbar.Add("Failed to capture snapshot.", Severity.Error);
        }
    }

    private static Color GetConnectionColor(CameraConnectionState? state)
        => state switch
        {
            CameraConnectionState.Connected => Color.Success,
            CameraConnectionState.Connecting or CameraConnectionState.Reconnecting => Color.Warning,
            CameraConnectionState.Error => Color.Error,
            _ => Color.Default,
        };

    public void Dispose()
    {
        Hub.OnConnectionStateChanged -= OnConnectionStateChanged;
        Hub.OnRecordingStateChanged -= OnRecordingStateChanged;
    }
}