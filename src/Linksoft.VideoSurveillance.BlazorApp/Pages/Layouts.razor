@page "/layouts"
@inject GatewayService Gateway
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">Layouts</MudText>

<MudPaper Class="pa-4 mb-4" MaxWidth="500px">
    <MudText Typo="Typo.h6" Class="mb-2">Create Layout</MudText>
    <MudStack Row="true" AlignItems="AlignItems.End" Spacing="2">
        <MudTextField @bind-Value="newLayoutName" Label="Name" />
        <MudNumericField @bind-Value="newRows" Label="Rows" Min="1" Max="8" />
        <MudNumericField @bind-Value="newColumns" Label="Columns" Min="1" Max="8" />
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="CreateLayoutAsync"
                   Disabled="string.IsNullOrWhiteSpace(newLayoutName)">
            Create
        </MudButton>
    </MudStack>
</MudPaper>

@if (isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudTable Items="@layouts" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Grid</MudTh>
            <MudTh>Cameras</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Grid">@(context.Rows)x@(context.Columns)</MudTd>
            <MudTd DataLabel="Cameras">@(context.Cameras?.Count ?? 0)</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.GridView"
                               Size="Size.Small"
                               Color="Color.Primary"
                               OnClick="@(() => EditLayout(context))" />
                <MudButton Size="Size.Small"
                           Variant="Variant.Outlined"
                           Color="Color.Primary"
                           OnClick="@(() => ApplyLayoutAsync(context))">
                    Apply
                </MudButton>
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Size="Size.Small"
                               Color="Color.Error"
                               OnClick="@(() => DeleteLayoutAsync(context))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No layouts configured. Create one above.</MudText>
        </NoRecordsContent>
    </MudTable>
}

@if (editingLayout is not null && cameras is not null)
{
    <MudDivider Class="my-4" />
    <LayoutEditor @ref="editorRef"
                  Layout="editingLayout"
                  AllCameras="cameras"
                  OnSave="OnEditorSaveAsync"
                  OnCancel="CancelEdit" />
}

@code {
    private Layout[]? layouts;
    private Camera[]? cameras;
    private Layout? editingLayout;
    private LayoutEditor? editorRef;
    private bool isLoading = true;

    private string newLayoutName = string.Empty;
    private int newRows = 2;
    private int newColumns = 2;

    protected override async Task OnInitializedAsync()
    {
        cameras = await Gateway.GetCamerasAsync();
        await LoadLayoutsAsync();
    }

    private async Task LoadLayoutsAsync()
    {
        isLoading = true;
        layouts = await Gateway.GetLayoutsAsync();
        isLoading = false;
    }

    private async Task CreateLayoutAsync()
    {
        var request = new CreateLayoutRequest(
            Name: newLayoutName,
            Rows: newRows,
            Columns: newColumns);

        var result = await Gateway.CreateLayoutAsync(request);
        if (result is not null)
        {
            Snackbar.Add($"Layout '{newLayoutName}' created.", Severity.Success);
            newLayoutName = string.Empty;
            await LoadLayoutsAsync();
        }
        else
        {
            Snackbar.Add("Failed to create layout.", Severity.Error);
        }
    }

    private async Task ApplyLayoutAsync(Layout layout)
    {
        var result = await Gateway.ApplyLayoutAsync(layout.Id);
        if (result is not null)
        {
            Snackbar.Add($"Layout '{layout.Name}' applied.", Severity.Success);
        }
        else
        {
            Snackbar.Add("Failed to apply layout.", Severity.Error);
        }
    }

    private async Task DeleteLayoutAsync(Layout layout)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"Delete layout '{layout.Name}'? This cannot be undone." },
            { x => x.ButtonText, "Delete" },
            { x => x.Color, Color.Error },
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Layout", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await Gateway.DeleteLayoutAsync(layout.Id);
            Snackbar.Add($"Layout '{layout.Name}' deleted.", Severity.Success);

            if (editingLayout?.Id == layout.Id)
            {
                editingLayout = null;
            }

            await LoadLayoutsAsync();
        }
    }

    private void EditLayout(Layout layout)
    {
        editingLayout = layout;
    }

    private async Task OnEditorSaveAsync()
    {
        var request = editorRef?.LastSaveRequest;
        if (editingLayout is null || request is null)
        {
            return;
        }

        var result = await Gateway.UpdateLayoutAsync(editingLayout.Id, request);
        if (result is not null)
        {
            Snackbar.Add($"Layout '{editingLayout.Name}' saved.", Severity.Success);
            editingLayout = null;
            await LoadLayoutsAsync();
        }
        else
        {
            Snackbar.Add("Failed to save layout.", Severity.Error);
        }
    }

    private void CancelEdit()
    {
        editingLayout = null;
    }
}