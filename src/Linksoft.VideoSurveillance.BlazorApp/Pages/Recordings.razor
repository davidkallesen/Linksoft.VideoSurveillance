@page "/recordings"
@inject GatewayService Gateway
@inject SurveillanceHubService Hub
@inject IDialogService DialogService
@inject IJSRuntime JS
@implements IDisposable

<MudText Typo="Typo.h4" Class="mb-4">Recordings</MudText>

<MudStack Row="true" AlignItems="AlignItems.End" Spacing="2" Class="mb-4">
    <MudTextField @bind-Value="filterCameraIdText"
                  Label="Filter by Camera ID"
                  Placeholder="Leave empty for all"
                  Style="max-width: 350px;" />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadRecordingsAsync">
        Refresh
    </MudButton>
</MudStack>

@if (isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudTable Items="@recordings" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>Camera</MudTh>
            <MudTh>File Path</MudTh>
            <MudTh>Started</MudTh>
            <MudTh>Duration</MudTh>
            <MudTh>Size</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Camera">@(context.CameraName ?? context.CameraId.ToString()[..8])</MudTd>
            <MudTd DataLabel="File Path">
                <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    @context.FilePath
                </MudText>
            </MudTd>
            <MudTd DataLabel="Started">@context.StartedAt.LocalDateTime.ToString("g", CultureInfo.CurrentCulture)</MudTd>
            <MudTd DataLabel="Duration">@(context.Duration ?? "-")</MudTd>
            <MudTd DataLabel="Size">@FormatSize(context.FileSizeBytes)</MudTd>
            <MudTd>
                @if (!string.IsNullOrEmpty(context.FilePath))
                {
                    <MudIconButton Icon="@Icons.Material.Filled.PlayCircle"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   OnClick="@(() => PlayRecordingAsync(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Download"
                                   Size="Size.Small"
                                   OnClick="@(() => DownloadRecordingAsync(context))" />
                }
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No recordings found.</MudText>
        </NoRecordsContent>
    </MudTable>
}

@code {
    private Recording[]? recordings;
    private bool isLoading = true;
    private string filterCameraIdText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Hub.OnRecordingStateChanged += OnRecordingStateChanged;

        await Hub.ConnectAsync();
        await LoadRecordingsAsync();
    }

    private async Task LoadRecordingsAsync()
    {
        isLoading = true;

        Guid? cameraId = Guid.TryParse(filterCameraIdText, out var parsed) ? parsed : null;
        recordings = await Gateway.GetRecordingsAsync(cameraId);

        isLoading = false;
    }

    private void OnRecordingStateChanged(SurveillanceHubService.RecordingStateEvent e)
    {
        if (string.Equals(e.NewState, "Stopped", StringComparison.OrdinalIgnoreCase))
        {
            InvokeAsync(async () =>
            {
                await LoadRecordingsAsync();
                StateHasChanged();
            });
        }
    }

    private string GetRecordingFileUrl(Recording recording)
        => Gateway.GetRecordingFileUrl(recording.FilePath);

    private async Task PlayRecordingAsync(Recording recording)
    {
        var url = GetRecordingFileUrl(recording);
        var title = !string.IsNullOrEmpty(recording.CameraName)
            ? $"{recording.CameraName} - {recording.StartedAt.LocalDateTime:g}"
            : $"Recording - {recording.StartedAt.LocalDateTime:g}";

        var parameters = new DialogParameters<RecordingPlaybackDialog>
        {
            { x => x.VideoUrl, url },
            { x => x.Title, title },
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseOnEscapeKey = true,
        };

        await DialogService.ShowAsync<RecordingPlaybackDialog>("Playback", parameters, options);
    }

    private async Task DownloadRecordingAsync(Recording recording)
    {
        var url = GetRecordingFileUrl(recording);
        var fileName = Path.GetFileName(recording.FilePath);
        await JS.InvokeVoidAsync("fileInterop.downloadFromUrl", url, fileName);
    }

    private static string FormatSize(long? bytes)
    {
        if (bytes is null or 0)
        {
            return "-";
        }

        var b = bytes.Value;
        if (b >= 1024L * 1024 * 1024)
        {
            return $"{b / (1024.0 * 1024 * 1024):F2} GB";
        }

        if (b >= 1024 * 1024)
        {
            return $"{b / (1024.0 * 1024):F1} MB";
        }

        if (b >= 1024)
        {
            return $"{b / 1024.0:F1} KB";
        }

        return $"{b} B";
    }

    public void Dispose()
    {
        Hub.OnRecordingStateChanged -= OnRecordingStateChanged;
    }
}